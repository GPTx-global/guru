#!/bin/bash


NODE_TYPE="val"
NODE_INDEX="0"

KEYS[0]="dev0"
KEYS[1]="dev1"
KEYS[2]="dev2"
KEYS[3]="dev3"
KEYS[4]="dev4"
KEYS[5]="dev5"
KEYS[6]="dev6"
KEYS[7]="dev7"
KEYS[8]="dev8"
KEYS[9]="dev9"
KEYS[10]="modkey"
# KEY_TESTER="tester"


ADDRESSES[0]="guru10jmp6sgh4cc6zt3e8gw05wavvejgr5pwggsdaj"
ADDRESSES[1]="guru1cml96vmptgw99syqrrz8az79xer2pcgpawsch9"
ADDRESSES[2]="guru1jcltmuhplrdcwp7stlr4hlhlhgd4htqhtx0smk"
ADDRESSES[3]="guru1gzsvk8rruqn2sx64acfsskrwy8hvrmaf6dvhj3"
ADDRESSES[4]="guru1fx944mzagwdhx0wz7k9tfztc8g3lkfk6ecee3f"
ADDRESSES[5]="guru174mfr668p349h6dxt52rfpsr0n85hux8w8m93r"
ADDRESSES[6]="guru1e2rnhff8v20n4v7xgt4sgrmwgl0ykqqw7ka9cf"
ADDRESSES[7]="guru1y5v8wgnfhzx8xh4kq4knf0eat3qrw6kguclz03"
ADDRESSES[8]="guru18c8ea0tuwh40dqecuvcdhlthetn8gexra94jg0"
ADDRESSES[9]="guru15mu7d4th0acqdfulsgd4epsxcv02qlngg4sgvk"
ADDRESSES[10]="guru17nywmzjr248agulkw584yt7qfvatq8dmp0ly06"

# address 0x7cb61d4117ae31a12e393a1cfa3bac666481d02e | guru10jmp6sgh4cc6zt3e8gw05wavvejgr5pwggsdaj | pk e9b1d63e8acd7fe676acb43afb390d4b0202dab61abec9cf2a561e4becb147de
MNICS[0]="gesture inject test cycle original hollow east ridge hen combine junk child bacon zero hope comfort vacuum milk pitch cage oppose unhappy lunar seat"
# address 0xc6fe5d33615a1c52c08018c47e8bc53646a0e101 | guru1cml96vmptgw99syqrrz8az79xer2pcgpawsch9 | pk 88cbead91aee890d27bf06e003ade3d4e952427e88f88d31d61d3ef5e5d54305
MNICS[1]="copper push brief egg scan entry inform record adjust fossil boss egg comic alien upon aspect dry avoid interest fury window hint race symptom"
# address 0x963ebdf2e1f8db8707d05fc75bfeffba1b5bac17 | guru1jcltmuhplrdcwp7stlr4hlhlhgd4htqhtx0smk | pk 741de4f8988ea941d3ff0287911ca4074e62b7d45c991a51186455366f10b544
MNICS[2]="maximum display century economy unlock van census kite error heart snow filter midnight usage egg venture cash kick motor survey drastic edge muffin visual"
# address 0x40a0cb1C63e026A81B55EE1308586E21eec1eFa9 | guru1gzsvk8rruqn2sx64acfsskrwy8hvrmaf6dvhj3 | pk 3b7955d25189c99a7468192fcbc6429205c158834053ebe3f78f4512ab432db9
MNICS[3]="will wear settle write dance topic tape sea glory hotel oppose rebel client problem era video gossip glide during yard balance cancel file rose"
# address 0x498B5AeC5D439b733dC2F58AB489783A23FB26dA | guru1fx944mzagwdhx0wz7k9tfztc8g3lkfk6ecee3f | pk 8a36c69d940a92fcea94b36d0f2928c7a0ee19a90073eda769693298dfa9603b
MNICS[4]="doll midnight silk carpet brush boring pluck office gown inquiry duck chief aim exit gain never tennis crime fragile ship cloud surface exotic patch"
# address 0xf57691eb470c6a5be9a65d143486037ccf4bf0c7 | guru174mfr668p349h6dxt52rfpsr0n85hux8w8m93r | pk 2808ebf3f798b26bd04db0f9ffdefc58fa1d9418ce38b2f17e0c504041ebabe4
MNICS[5]="cliff shy upon mention front rhythm panel drastic bachelor shrimp candy air carpet level monkey unfair above off debris hurry frown kick food copy"
# address 0xca873ba527629f3ab3c642eb040f6e47de4b000e | guru1e2rnhff8v20n4v7xgt4sgrmwgl0ykqqw7ka9cf | pk 84ba151c1a792c0f95d3c4f1dea57ef14daa3c4c8949d9f993b963fea4972c8c
MNICS[6]="jump task rate pistol asset brother wheat warm risk reward divorce unfair anxiety crawl off warrior denial flush clip empty sure network ginger crunch"
# address 0x2518772269b88c735eb6056d34bf3d5c40376ac8 | guru1y5v8wgnfhzx8xh4kq4knf0eat3qrw6kguclz03 | pk 4f04ea016df6d8547512578d85b81472ea7be8261eb0ffb0afd13108e840c08a
MNICS[7]="hazard student spoil reform cluster flock purity dwarf spatial poet early chair exist ice food sheriff swap assist emotion work snack pass asset timber"
# address 0x3e0f9ebd7c75eaf68338e330dbfd77cae67464c3 | guru18c8ea0tuwh40dqecuvcdhlthetn8gexra94jg0 | pk 23ff3d3cdb17a9129ebcedc56136b02796706af35a39959307473155c5ea49dc
MNICS[8]="unfold rotate test false round multiply measure catch pumpkin leaf mystery boil honey bridge toss gold enforce sort will marriage walk evidence task stairs"
# address 0xa6f9e6d5777f7006a79f821b5c8606c31ea07e68 | guru15mu7d4th0acqdfulsgd4epsxcv02qlngg4sgvk | pk cfc910bd690a3437d76f185c4f362b7a8356129b99526119ef16303917be6972
MNICS[9]="charge gloom capital outdoor ride mixture barely virus better depth admit speed turtle broccoli air find rib adult bid stock bar wreck amazing resist"
# address 0xf4c8ed8a43554fd473f6750f522fc04b3ab01dbb | guru17nywmzjr248agulkw584yt7qfvatq8dmp0ly06 | pk 6ce5e03653734b01a80f2af3bb52747e63a375d3af13e86f84201074aa137d93
MNICS[10]="today embody fade mesh hazard morning pink debris version inherit more raise author beyond arena eager sword abandon tourist file negative ski dolphin south"

CHAINID="guru_3110-1"
MONIKER="localtestnet"
KEYRING="test"
KEYALGO="eth_secp256k1" #gitleaks:allow
LOGLEVEL="info"
# to trace evm
#TRACE="--trace"
TRACE=""
PRUNING="default"
#PRUNING="custom"

CHAINDIR="$HOME/.tmp-gurud-hermes"
GENESIS="$CHAINDIR/config/genesis.json"
TMP_GENESIS="$CHAINDIR/config/tmp_genesis.json"
APP_TOML="$CHAINDIR/config/app.toml"
CONFIG_TOML="$CHAINDIR/config/config.toml"
DNOM="./build/gurud"

# validate dependencies are installed
command -v jq > /dev/null 2>&1 || { echo >&2 "jq not installed. More info: https://stedolan.github.io/jq/download/"; exit 1; }

# used to exit on first error (any non-zero exit code)
set -e

rm -rf "$CHAINDIR"

# Set client config
$DNOM config keyring-backend "$KEYRING"
$DNOM config chain-id "$CHAINID"


# dev0 is the unique signer added in each node
# echo "${MNICS[$NODE_INDEX]}" | $DNOM keys add "${KEYS[$NODE_INDEX]}" --recover --keyring-backend "$KEYRING" --algo "$KEYALGO" --home "$CHAINDIR"
# dev1 is the common acocunt for each node with balance
# echo "${MNICS[9]}" | $DNOM keys add "${KEYS[9]}" --recover --keyring-backend "$KEYRING" --algo "$KEYALGO" --home "$CHAINDIR"
# modkey is added for all nodes
# echo "${MNICS[10]}" | $DNOM keys add "${KEYS[10]}" --recover --keyring-backend "$KEYRING" --algo "$KEYALGO" --home "$CHAINDIR"
# tester account is randomly created for each node for test
# $DNOM keys add "$KEY_TESTER" --keyring-backend $KEYRING --algo "$KEYALGO"

# If keys exist they should be deleted
for i in "${!KEYS[@]}"; do
    echo "${MNICS[i]}" | $DNOM keys add "${KEYS[i]}" --recover --keyring-backend "$KEYRING" --algo "$KEYALGO" --home "$CHAINDIR"
done

# Set moniker and chain-id for Guru (Moniker can be anything, chain-id must be an integer)
$DNOM init "$MONIKER" --chain-id "$CHAINID"

# Change parameter token denominations to aguru
jq '.app_state.staking.params.bond_denom="aguru"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.crisis.constant_fee.denom="aguru"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.gov.deposit_params.min_deposit[0].denom="aguru"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.evm.params.evm_denom="aguru"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.inflation.params.mint_denom="aguru"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# set gov proposing && voting period
jq '.app_state.gov.deposit_params.max_deposit_period="30s"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.gov.voting_params.voting_period="30s"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# Set gas limit in genesis
jq '.consensus_params.block.max_gas="10000000"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# Set claims start time
# node_address=${ADDRESSES[0]}
# node_address=$($DNOM keys list | grep  "address: " | cut -c12-)
node_address=$($DNOM keys show -a "${KEYS[0]}" --keyring-backend "$KEYRING" --home "$CHAINDIR")
current_date=$(date -u +"%Y-%m-%dT%TZ")
jq -r --arg current_date "$current_date" '.app_state.claims.params.airdrop_start_time=$current_date' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# Set claims records for validator account
amount_to_claim=10000
jq -r --arg node_address "$node_address" --arg amount_to_claim "$amount_to_claim" '.app_state.claims.claims_records=[{"initial_claimable_amount":$amount_to_claim, "actions_completed":[false, false, false, false],"address":$node_address}]' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# Set claims decay
jq '.app_state.claims.params.duration_of_decay="1000000s"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq '.app_state.claims.params.duration_until_decay="100000s"' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# Claim module account:
# 0xA61808Fe40fEb8B3433778BBC2ecECCAA47c8c47 || guru15cvq3ljql6utxseh0zau9m8ve2j8erz8lq9ma5
jq -r --arg amount_to_claim "$amount_to_claim" '.app_state.bank.balances += [{"address":"guru15cvq3ljql6utxseh0zau9m8ve2j8erz8lq9ma5","coins":[{"denom":"aguru", "amount":$amount_to_claim}]}]' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# Set the distribution module moderator and base address:
# jq -r --arg moderator_address "$($DNOM keys show $KEY --address --keyring-backend "$KEYRING" --home "$CHAINDIR")" '.app_state["distribution"]["moderator_address"] = $moderator_address' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
# jq -r --arg base_address "$($DNOM keys show $KEY --address --keyring-backend "$KEYRING" --home "$CHAINDIR")" '.app_state["distribution"]["base_address"] = $base_address' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq -r --arg moderator_address "$($DNOM keys show ${KEYS[10]} --address --keyring-backend "$KEYRING" --home "$CHAINDIR")" '.app_state["distribution"]["moderator_address"]="guru17nywmzjr248agulkw584yt7qfvatq8dmp0ly06"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"
jq -r --arg base_address "$($DNOM keys show ${KEYS[10]} --address --keyring-backend "$KEYRING" --home "$CHAINDIR")" '.app_state["distribution"]["base_address"]="guru17nywmzjr248agulkw584yt7qfvatq8dmp0ly06"' "$GENESIS" >"$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"


# disable produce empty block
sed -i 's/create_empty_blocks = true/create_empty_blocks = false/g' "$CONFIG_TOML"

# Allocate genesis accounts (cosmos formatted addresses)
for KEY in "${KEYS[@]}"; do
	$DNOM add-genesis-account "$KEY" 100000000000000000000000000aguru --keyring-backend $KEYRING --home "$CHAINDIR"
done
# $DNOM add-genesis-account $(KEYS 100000000000000000000000000aguru --keyring-backend $KEYRING

# Update total supply with claim values
# Bc is required to add this big numbers
# total_supply=$(bc <<< "$amount_to_claim+$validators_supply")
# total_supply=100000000000000000000010000
total_supply=$(echo "${#KEYS[@]} * 100000000000000000000000000 + $amount_to_claim" | bc)
jq -r --arg total_supply "$total_supply" '.app_state.bank.supply[0].amount=$total_supply' "$GENESIS" > "$TMP_GENESIS" && mv "$TMP_GENESIS" "$GENESIS"

# set custom pruning settings
if [ "$PRUNING" = "custom" ]; then
  sed -i 's/pruning = "default"/pruning = "custom"/g' "$APP_TOML"
  sed -i 's/pruning-keep-recent = "0"/pruning-keep-recent = "2"/g' "$APP_TOML"
  sed -i 's/pruning-interval = "0"/pruning-interval = "10"/g' "$APP_TOML"
fi

# make sure the localhost IP is 0.0.0.0
sed -i 's/pprof_laddr = "localhost:6060"/pprof_laddr = "0.0.0.0:6060"/g' "$CONFIG_TOML"
sed -i 's/127.0.0.1/0.0.0.0/g' "$APP_TOML"

# Sign genesis transaction
$DNOM gentx $node_address 1000000000000000000000aguru --keyring-backend $KEYRING --home "$CHAINDIR" --chain-id "$CHAINID"
## In case you want to create multiple validators at genesis
## 1. Back to `$DNOM keys add` step, init more keys
## 2. Back to `$DNOM add-genesis-account` step, add balance for those
## 3. Clone this ~/.$DNOM home directory into some others, let's say `~/.clonedGurud`
## 4. Run `gentx` in each of those folders
## 5. Copy the `gentx-*` folders under `~/.clonedGurud/config/gentx/` folders into the original `~/.gurud/config/gentx`

# Collect genesis tx
$DNOM collect-gentxs

# Run this to ensure everything worked and that the genesis file is setup correctly
$DNOM validate-genesis

# Start the node (remove the --pruning=nothing flag if historical queries are not needed)
$DNOM start "$TRACE" --log_level $LOGLEVEL --minimum-gas-prices=0.0001aguru --json-rpc.api eth,txpool,personal,net,debug,web3

